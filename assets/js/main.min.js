const CUSTOMIZATION_LOCAL_STORAGE_KEY = 'site-theme'

class masterCustomization {
    constructor() {
        this.isOpen = false
        this.activeTheme = 'default-theme'
        this.hasLocalStorage = typeof Storage !== 'undefined'

        this.themePicker = document.querySelector('.master-customization')
        this.toggleBtn = document.querySelector('.js-master-customization-toggle')
        this.themes = Array.from (
            document.querySelectorAll('.js-master-customization-theme')
        )

        this.initialize()
    }

    initialize() {
        this.toggleBtn.removeAttribute('hidden')
        this.toggleBtn.classList.remove('is-hidden')

        const systemPreference = this.getSystemPreference()
        const storedPreference = this.getStoredPreference()

        if (storedPreference) {
            this.activeTheme = storedPreference
        } else if (systemPreference) {
            this.activeTheme = systemPreference
        }

        this.setActiveItem()
        this.bindEvents()
    }

    bindEvents() {
        this.toggleBtn.addEventListener('click', () => this.togglePicker())

        this.themes.forEach((btn) => {
            const id = btn.dataset.siteTheme

            if (id) {
                btn.addEventListener('click', () => this.setTheme(id))
            }
        })
    }

    getSystemPreference() {
        if (window.matchMedia('(prefers-color-scheme:dark)').matches) {
            return 'dim-theme'
        }
        return false
    }

    getStoredPreference() {
        if (this.hasLocalStorage) {
            return localStorage.getItem(CUSTOMIZATION_LOCAL_STORAGE_KEY)
        }
        return false
    }

    setActiveItem() {
        this.themes.forEach((btn) => {
            btn.classList.remove('is-active')
            btn.removeAttribute('aria-checked')

            if (btn.dataset.siteTheme === this.activeTheme) {
                btn.classList.add('is-active')
                btn.setAttribute('aria-checked', 'true')
            }
        })
    }

    setTheme(id) {
        this.activeTheme = id
        document.documentElement.setAttribute('data-site-theme', id)

        if (this.hasLocalStorage) {
            localStorage.setItem(CUSTOMIZATION_LOCAL_STORAGE_KEY, id)
        }

        this.setActiveItem()
    }

    togglePicker(force) {
        this.isOpen = typeof force === 'boolean' ? force : !this.isOpen
        
        this.toggleBtn.setAttribute('aria-expanded', String(this.isOpen))

        if(this.isOpen) {
            this.themePicker.removeAttribute('hidden')
            window.setTimeout(() => {
                this.themePicker.classList.add('is-open')
            }, 1)
            this.themes[0].focus()
        } else {
            this.themePicker.setAttribute('hidden', true)
        }
        this.themePicker.classList.remove('is-open')
        this.toggleBtn.focus()
    }
}

if (document.querySelector('.master-navigation') && window.CSS && CSS.supports('color', 'var(--fake-var)')) {
    new masterCustomization()
}

if (document.querySelector('.js-showcase-view')) {
    const showCaseView = document.querySelector('.js-showcase-view')
    const masterNavbar = document.querySelector('.master-navigation')

    window.addEventListener('scroll', (e) => {
        var scroll = document.scrollingElement.scrollTop
        var position = showCaseView.offsetTop

        if (scroll > position) {
            masterNavbar.classList.add('on-showcase-view')
        } else {
            masterNavbar.classList.remove('on-showcase-view')
        }
    })
}